<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS MINER - Tek Dosya Modu</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background: #000; color: white; font-family: sans-serif; overflow-x: hidden; }
        .glass { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; }
        .btn { background: #00f2ff; color: #000; font-weight: bold; border-radius: 8px; padding: 10px; width: 100%; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="p-4 flex flex-col gap-4">

    <div class="flex justify-between items-center glass p-4">
        <div>
            <div class="text-xs text-gray-400">BAKÄ°YE</div>
            <div id="ui-balance" class="text-2xl font-bold text-cyan-400">---</div>
        </div>
        <div id="save-status" class="text-xs text-yellow-500 font-bold">BaÄŸlanÄ±yor...</div>
    </div>

    <h2 class="text-lg font-bold mt-4">Market</h2>
    <div id="market-list" class="grid grid-cols-2 gap-4">
        </div>

    <h2 class="text-lg font-bold mt-4">Envanterim</h2>
    <div id="inventory-list" class="glass p-4 min-h-[100px] text-xs text-gray-400">
        HenÃ¼z cihaz yok.
    </div>

    <div id="error-box" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-6">
        <div class="bg-red-900 border border-red-500 p-6 rounded-xl w-full">
            <h2 class="text-xl font-bold text-red-500 mb-2">HATA OLUÅžTU!</h2>
            <p id="error-text" class="text-white text-xs font-mono mb-4 break-all"></p>
            <button onclick="location.reload()" class="btn bg-white text-black">SayfayÄ± Yenile</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. AYARLAR
        const firebaseConfig = {
            apiKey: "AIzaSyDXwByb4qNJeH5F9pYA8ry-zYcBhdzKsOo",
            authDomain: "tonm-77373.firebaseapp.com",
            projectId: "tonm-77373",
            storageBucket: "tonm-77373.firebasestorage.app",
            messagingSenderId: "507031118335",
            appId: "1:507031118335:web:1d209e303dca154ec487ca",
            measurementId: "G-5EV1T50VK8"
        };

        // 2. BAÅžLATMA
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("ðŸ”¥ Firebase BaÅŸladÄ±");
        } catch (e) {
            showError("Firebase BaÅŸlatÄ±lamadÄ±: " + e.message);
        }

        // 3. OYUN VERÄ°LERÄ°
        const userID = "PATRON_USER_SABIT"; // Sabit ID
        let gameState = {
            balance: 10,
            inventory: {}
        };

        const products = [
            { id: 1, name: "Nano Node", price: 10 },
            { id: 2, name: "Micro Rig", price: 30 }
        ];

        // 4. FONKSÄ°YONLAR
        function updateUI() {
            document.getElementById('ui-balance').innerText = gameState.balance.toFixed(2) + " TON";
            
            // Envanter
            const invDiv = document.getElementById('inventory-list');
            const items = Object.entries(gameState.inventory);
            if(items.length > 0) {
                invDiv.innerHTML = items.map(([id, count]) => {
                    const p = products.find(x => x.id == id);
                    return `<div>${p.name}: <span class="text-white font-bold">x${count}</span></div>`;
                }).join('');
            } else {
                invDiv.innerText = "HenÃ¼z cihaz yok.";
            }
        }

        function renderMarket() {
            const list = document.getElementById('market-list');
            list.innerHTML = products.map(p => `
                <div class="glass p-4 text-center">
                    <div class="font-bold">${p.name}</div>
                    <div class="text-xs text-gray-400 mb-2">${p.price} TON</div>
                    <button onclick="window.buyItem(${p.id})" class="btn">SATIN AL</button>
                </div>
            `).join('');
        }

        // --- KRÄ°TÄ°K BÃ–LÃœM: KAYDETME VE YÃœKLEME ---

        async function saveGame() {
            const status = document.getElementById('save-status');
            status.innerText = "Kaydediliyor...";
            status.className = "text-xs text-yellow-500 font-bold animate-pulse";

            try {
                await setDoc(doc(db, "users", userID), gameState, { merge: true });
                
                status.innerText = "âœ… Kaydedildi";
                status.className = "text-xs text-green-500 font-bold";
                setTimeout(() => { status.innerText = "HazÄ±r"; status.className = "text-xs text-gray-500"; }, 2000);
            } catch (error) {
                console.error(error);
                status.innerText = "âŒ HATA!";
                status.className = "text-xs text-red-500 font-bold";
                
                if(error.message.includes("permission-denied")) {
                    showError("KAYIT BAÅžARISIZ! Firebase KurallarÄ± (Rules) hala kilitli. LÃ¼tfen Firebase Konsolundan kurallarÄ± 'allow read, write: if true;' yapÄ±p YAYINLA butonuna bas.");
                } else {
                    showError("KayÄ±t HatasÄ±: " + error.message);
                }
            }
        }

        async function loadGame() {
            const status = document.getElementById('save-status');
            status.innerText = "YÃ¼kleniyor...";
            
            try {
                const docSnap = await getDoc(doc(db, "users", userID));
                if (docSnap.exists()) {
                    gameState = { ...gameState, ...docSnap.data() };
                    status.innerText = "Veri YÃ¼klendi";
                    updateUI();
                } else {
                    status.innerText = "Yeni KullanÄ±cÄ±";
                    saveGame(); // Ä°lk kaydÄ± oluÅŸtur
                }
            } catch (error) {
                console.error(error);
                showError("Veri Okuma HatasÄ±: " + error.message);
            }
        }

        // Global Fonksiyonlar
        window.buyItem = (id) => {
            const p = products.find(x => x.id == id);
            if(gameState.balance >= p.price) {
                gameState.balance -= p.price;
                if(!gameState.inventory[id]) gameState.inventory[id] = 0;
                gameState.inventory[id]++;
                updateUI();
                saveGame(); // SatÄ±n alÄ±nca kaydet
            } else {
                alert("Yetersiz Bakiye!");
            }
        };

        function showError(msg) {
            document.getElementById('error-box').classList.remove('hidden');
            document.getElementById('error-text').innerText = msg;
        }

        // BAÅžLAT
        renderMarket();
        updateUI();
        loadGame();

    </script>
</body>
</html>
